const API_BASE="https://cod-extension.netlify.app";let authToken=null,channelId=null,refreshInterval=null;const loadingState=document.getElementById("loadingState"),errorState=document.getElementById("errorState"),loadoutsContainer=document.getElementById("loadoutsContainer"),loadoutTabs=document.getElementById("loadoutTabs"),loadoutContent=document.getElementById("loadoutContent"),statusIndicator=document.getElementById("statusIndicator"),statusDot=statusIndicator.querySelector(".status-dot"),statusText=statusIndicator.querySelector(".status-text"),errorMessage=document.getElementById("errorMessage"),retryBtn=document.getElementById("retryBtn");let currentLoadouts=[],activeLoadoutIndex=0;function initializeTwitchExtension(){window.Twitch&&window.Twitch.ext?(window.Twitch.ext.onAuthorized(e=>{authToken=e.token,channelId=e.channelId,console.log("Twitch Extension Authorized:",{channelId:channelId}),updateStatus("connected","Connected"),loadLoadouts()}),window.Twitch.ext.onContext(e=>{console.log("Twitch Context:",e)}),window.Twitch.ext.onVisibilityChanged(e=>{console.log("Visibility changed:",e),e&&channelId&&loadLoadouts()})):(console.error("Twitch Extension Helper not available"),updateStatus("error","Twitch Helper Error"),showError("Twitch Extension Helper not loaded"))}function updateStatus(e,n){statusText.textContent=n,statusDot.className=`status-dot ${e}`}function showLoading(){loadingState.style.display="flex",errorState.style.display="none",loadoutsContainer.style.display="none"}function showError(e){errorMessage.textContent=e,loadingState.style.display="none",errorState.style.display="flex",loadoutsContainer.style.display="none",updateStatus("error","Error")}function showLoadouts(){loadingState.style.display="none",errorState.style.display="none",loadoutsContainer.style.display="block",updateStatus("connected","Connected")}async function fetchLoadouts(e,n){const t={"Content-Type":"application/json"};n&&(t.Authorization=`Bearer ${n}`);try{const n=await fetch(`${API_BASE}/api/loadouts/${e}`,{method:"GET",headers:t});if(n.ok){const e=await n.json();return e&&"object"==typeof e&&!Array.isArray(e)?Object.values(e):e}}catch(e){console.log("Primary endpoint failed, trying fallback...")}try{const n=await fetch(`${API_BASE}/api/loadouts/${e}`,{method:"GET",headers:t});if(n.ok){return(await n.json()).loadouts||[]}}catch(e){console.log("Fallback endpoint failed, trying streamers list...")}throw console.log("Primary and fallback endpoints failed"),console.log("All endpoints failed"),new Error(`All API endpoints failed for channel ${e}. Check console for details.`)}async function loadLoadouts(){if(channelId)try{showLoading();const e=await fetchLoadouts(channelId,authToken);if(!e||0===e.length)return void showNoLoadouts();currentLoadouts=e.slice(0,5),renderTabbedLoadouts(currentLoadouts),showLoadouts()}catch(e){console.error("Error loading loadouts:",e),showError(`Failed to load loadouts: ${e.message}`)}else showError("Channel ID not available")}function showNoLoadouts(){loadoutTabs.innerHTML="",loadoutContent.innerHTML='\n    <div class="no-loadouts">\n      <div class="no-loadouts-icon">ðŸŽ®</div>\n      <p>No loadouts available for this streamer</p>\n    </div>\n  ',showLoadouts()}function renderLoadouts(e){loadoutsGrid.innerHTML="",e.forEach((e,n)=>{const t=createLoadoutCard(e,n+1);loadoutsGrid.appendChild(t)})}function createLoadoutCard(e,n){const t=document.createElement("div");t.className="loadout-card";const a=e.name||`Loadout ${n}`,o=e.primary||{},s=e.secondary||{},i=e.tactical||"None",d=e.lethal||"None",l=e.perks||[];return t.innerHTML=`\n        <div class="loadout-header">\n            <div class="loadout-name">${escapeHtml(a)}</div>\n            <div class="loadout-number">#${n}</div>\n        </div>\n        \n        ${renderWeaponSection("Primary",o)}\n        ${renderWeaponSection("Secondary",s)}\n        \n        <div class="equipment-section">\n            <div class="equipment-item">\n                <div class="equipment-label">Tactical</div>\n                <div class="equipment-name">${escapeHtml(i)}</div>\n            </div>\n            <div class="equipment-item">\n                <div class="equipment-label">Lethal</div>\n                <div class="equipment-name">${escapeHtml(d)}</div>\n            </div>\n        </div>\n        \n        <div class="perks-section">\n            <div class="perks-header">Perks</div>\n            <div class="perks-list">\n                ${l.map(e=>`<span class="perk">${escapeHtml(e)}</span>`).join("")}\n            </div>\n        </div>\n    `,t}function renderWeaponSection(e,n){if(!n||!n.name)return`\n            <div class="weapon-section">\n                <div class="weapon-header">${e}</div>\n                <div class="weapon-name">None</div>\n            </div>\n        `;const t=n.attachments||n.attachmentSlots||{},a=Object.entries(t).filter(([e,n])=>n&&"None"!==n).map(([e,n])=>`<span class="attachment">${escapeHtml("string"==typeof n?n:n?.name||"Unknown")}</span>`).join("");return`\n        <div class="weapon-section">\n            <div class="weapon-header">${e}</div>\n            <div class="weapon-info">\n                ${n.imageUrl?`<img src="${escapeHtml(n.imageUrl)}" alt="${escapeHtml(n.name)}" class="weapon-image" onerror="this.style.display='none'">`:""}\n                <div class="weapon-details">\n                    <div class="weapon-name">${escapeHtml(n.name)}</div>\n                    <div class="weapon-category">${escapeHtml(n.category||"Unknown")}</div>\n                </div>\n            </div>\n            ${a?`<div class="attachments">${a}</div>`:""}\n        </div>\n    `}function escapeHtml(e){if("string"!=typeof e)return e;const n=document.createElement("div");return n.textContent=e,n.innerHTML}function renderTabbedLoadouts(e){e&&0!==e.length?(loadoutTabs.innerHTML="",e.forEach((e,n)=>{const t=document.createElement("div");t.className="loadout-tab "+(n===activeLoadoutIndex?"active":""),t.textContent=e.name||`Loadout ${n+1}`,t.addEventListener("click",()=>switchToLoadout(n)),loadoutTabs.appendChild(t)}),renderActiveLoadout()):showNoLoadouts()}function switchToLoadout(e){if(e<0||e>=currentLoadouts.length)return;activeLoadoutIndex=e;loadoutTabs.querySelectorAll(".loadout-tab").forEach((n,t)=>{n.classList.toggle("active",t===e)}),renderActiveLoadout()}async function renderActiveLoadout(){if(!currentLoadouts[activeLoadoutIndex])return;const e=currentLoadouts[activeLoadoutIndex];loadoutContent.innerHTML=`\n    <div class="loadout-header">\n      <div class="loadout-name">${escapeHtml(e.name||`Loadout ${activeLoadoutIndex+1}`)}</div>\n    </div>\n    \n    ${await renderWeaponSectionWithImage("Primary",e.primary)}\n    ${await renderWeaponSectionWithImage("Secondary",e.secondary)}\n    \n    <div class="equipment-section">\n      <div class="equipment-item">\n        <div class="equipment-label">Tactical</div>\n        <div class="equipment-name">${escapeHtml(getEquipmentName(e.tactical))}</div>\n      </div>\n      <div class="equipment-item">\n        <div class="equipment-label">Lethal</div>\n        <div class="equipment-name">${escapeHtml(getEquipmentName(e.lethal))}</div>\n      </div>\n      <div class="equipment-item">\n        <div class="equipment-label">Field Upgrade</div>\n        <div class="equipment-name">${escapeHtml(getEquipmentName(e.fieldUpgrade))}</div>\n      </div>\n    </div>\n    \n    <div class="perks-section">\n      <div class="perks-header">Perks</div>\n      <div class="perks-list">\n        ${formatPerks(e.perks)}\n      </div>\n    </div>\n  `}async function renderWeaponSectionWithImage(e,n){if(!n||!n.name)return`\n      <div class="weapon-section">\n        <div class="weapon-header">${e}</div>\n        <div class="weapon-name">None</div>\n      </div>\n    `;let t=n.imageUrl||n.image;console.log(`Weapon ${n.name} imageUrl:`,t),t&&!t.startsWith("http")&&(t=null);const a=n.attachments||n.attachmentSlots||{},o=Object.entries(a).filter(([e,n])=>n&&"None"!==n).map(([e,n])=>{const t="string"==typeof n?n:n?.name||"Unknown";return`\n        <div class="attachment-item">\n          <span class="attachment-slot">${escapeHtml(e)}:</span>\n          <span class="attachment">${escapeHtml(t)}</span>\n        </div>\n      `}).join("");return`\n    <div class="weapon-section">\n      <div class="weapon-header">${e}</div>\n      <div class="weapon-name-large">${escapeHtml(n.name)}</div>\n      <div class="weapon-category">${escapeHtml(n.category||"Unknown")}</div>\n      ${t?`<div class="weapon-image-container">\n              <img src="${escapeHtml(t)}" alt="${escapeHtml(n.name)}" class="weapon-image-large" onerror="this.parentElement.style.display='none'">\n            </div>`:""}\n      ${o?`<div class="attachments-list">${o}</div>`:""}\n    </div>\n  `}function getEquipmentName(e){return e?"string"==typeof e?e:"object"==typeof e&&e.name?e.name:"None":"None"}function formatPerks(e){return e&&Array.isArray(e)?e.map(e=>{let n="Unknown Perk";return"string"==typeof e?n=e:"object"==typeof e&&e.name&&(n=e.name),`<span class="perk">${escapeHtml(n)}</span>`}).join(""):""}retryBtn.addEventListener("click",()=>{loadLoadouts()}),document.addEventListener("DOMContentLoaded",()=>{initializeTwitchExtension()}),window.addEventListener("beforeunload",()=>{refreshInterval&&clearInterval(refreshInterval)});