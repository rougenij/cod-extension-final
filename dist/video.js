const API_BASE="https://cod-extension.netlify.app";let authToken=null,channelId=null,refreshInterval=null,loadouts=[],currentLoadoutIndex=0,isExpanded=!0;const overlayWidget=document.getElementById("overlayWidget"),widgetContent=document.getElementById("widgetContent"),loadingOverlay=document.getElementById("loadingOverlay"),errorOverlay=document.getElementById("errorOverlay"),loadoutContent=document.getElementById("loadoutContent"),loadoutTitle=document.getElementById("loadoutTitle"),loadoutCounter=document.getElementById("loadoutCounter"),prevBtn=document.getElementById("prevBtn"),nextBtn=document.getElementById("nextBtn"),toggleBtn=document.getElementById("toggleBtn"),retryBtn=document.getElementById("retryBtn"),primaryIcon=document.getElementById("primaryIcon"),primaryName=document.getElementById("primaryName"),primaryCategory=document.getElementById("primaryCategory"),keyAttachment=document.getElementById("keyAttachment"),keyAttachmentValue=document.getElementById("keyAttachmentValue"),secondaryName=document.getElementById("secondaryName"),tacticalName=document.getElementById("tacticalName"),lethalName=document.getElementById("lethalName");function initializeTwitchExtension(){window.Twitch&&window.Twitch.ext?(window.Twitch.ext.onAuthorized(t=>{authToken=t.token,channelId=t.channelId,console.log("Video Overlay Authorized:",{channelId:channelId}),loadLoadouts(),refreshInterval&&clearInterval(refreshInterval),refreshInterval=setInterval(loadLoadouts,3e4)}),window.Twitch.ext.onContext(t=>{console.log("Twitch Context:",t)}),window.Twitch.ext.onVisibilityChanged(t=>{console.log("Video Overlay Visibility:",t),t&&channelId&&loadLoadouts()})):(console.error("Twitch Extension Helper not available"),showError())}function showLoading(){loadingOverlay.style.display="flex",errorOverlay.style.display="none",loadoutContent.style.display="none"}function showError(){loadingOverlay.style.display="none",errorOverlay.style.display="flex",loadoutContent.style.display="none"}function showContent(){loadingOverlay.style.display="none",errorOverlay.style.display="none",loadoutContent.style.display="block"}async function fetchLoadouts(t,e){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);try{const e=await fetch(`${API_BASE}/api/loadouts/${t}`,{method:"GET",headers:n});if(e.ok){const t=await e.json();return t&&"object"==typeof t&&!Array.isArray(t)?Object.values(t):t}}catch(t){console.log("Primary endpoint failed, trying fallback...")}try{const e=await fetch(`${API_BASE}/api/loadouts/${t}`,{method:"GET",headers:n});if(e.ok){return(await e.json()).loadouts||[]}}catch(t){console.log("Fallback endpoint failed")}return console.log("Primary and fallback endpoints failed"),console.log("All endpoints failed, no loadouts available"),[]}async function loadLoadouts(){if(channelId)try{showLoading();const t=await fetchLoadouts(channelId,authToken);if(!t||0===t.length)return loadouts=[],void showNoLoadouts();loadouts=t.slice(0,5),currentLoadoutIndex=Math.min(currentLoadoutIndex,loadouts.length-1),updateLoadoutDisplay(),updateNavigationButtons(),showContent()}catch(t){console.error("Error loading loadouts:",t),showError()}else showError()}function showNoLoadouts(){loadoutTitle.textContent="No Loadouts",loadoutCounter.textContent="0/0",primaryName.textContent="No loadouts available",primaryCategory.textContent="",secondaryName.textContent="-",tacticalName.textContent="-",lethalName.textContent="-",primaryIcon.style.display="none",keyAttachment.style.display="none",updateNavigationButtons(),showContent()}function updateLoadoutDisplay(){if(!loadouts||0===loadouts.length)return void showNoLoadouts();const t=loadouts[currentLoadoutIndex],e=currentLoadoutIndex+1;loadoutTitle.textContent=t.name||`Loadout #${e}`,loadoutCounter.textContent=`${e}/${loadouts.length}`;const n=t.primary||{};primaryName.textContent=n.name||"None",primaryCategory.textContent=n.category||"",n.imageUrl?(primaryIcon.src=n.imageUrl,primaryIcon.alt=n.name||"Primary weapon",primaryIcon.style.display="block",primaryIcon.onerror=()=>{primaryIcon.style.display="none"}):primaryIcon.style.display="none";const o=n.attachmentSlots||{},a=Object.entries(o).find(([t,e])=>e&&"None"!==e);a?(keyAttachmentValue.textContent=a[1],keyAttachment.style.display="flex"):keyAttachment.style.display="none";const l=t.secondary||{};secondaryName.textContent=l.name||"None",tacticalName.textContent=t.tactical||"None",lethalName.textContent=t.lethal||"None"}function updateNavigationButtons(){const t=loadouts&&loadouts.length>0,e=loadouts&&loadouts.length>1;prevBtn.disabled=!e||0===currentLoadoutIndex,nextBtn.disabled=!e||currentLoadoutIndex===loadouts.length-1,t||(prevBtn.disabled=!0,nextBtn.disabled=!0)}function navigatePrevious(){currentLoadoutIndex>0&&(currentLoadoutIndex--,updateLoadoutDisplay(),updateNavigationButtons())}function navigateNext(){currentLoadoutIndex<loadouts.length-1&&(currentLoadoutIndex++,updateLoadoutDisplay(),updateNavigationButtons())}function toggleExpanded(){isExpanded=!isExpanded,isExpanded?(widgetContent.classList.remove("collapsed"),toggleBtn.classList.remove("collapsed"),toggleBtn.textContent="▼",toggleBtn.title="Collapse"):(widgetContent.classList.add("collapsed"),toggleBtn.classList.add("collapsed"),toggleBtn.textContent="▲",toggleBtn.title="Expand")}function escapeHtml(t){if("string"!=typeof t)return t;const e=document.createElement("div");return e.textContent=t,e.innerHTML}prevBtn.addEventListener("click",navigatePrevious),nextBtn.addEventListener("click",navigateNext),toggleBtn.addEventListener("click",toggleExpanded),retryBtn.addEventListener("click",loadLoadouts),document.addEventListener("DOMContentLoaded",()=>{initializeTwitchExtension()}),window.addEventListener("beforeunload",()=>{refreshInterval&&clearInterval(refreshInterval)});