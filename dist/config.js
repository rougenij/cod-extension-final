const API_BASE="https://cod-extension.netlify.app";let authToken=null,channelId=null,currentConfig={overlayEnabled:!0,refreshInterval:30};const loadingState=document.getElementById("loadingState"),errorState=document.getElementById("errorState"),configForm=document.getElementById("configForm"),connectionStatus=document.getElementById("connectionStatus"),statusDot=document.getElementById("statusDot"),statusText=document.getElementById("statusText"),errorMessage=document.getElementById("errorMessage"),retryBtn=document.getElementById("retryBtn"),overlayEnabledInput=document.getElementById("overlayEnabled"),refreshIntervalSelect=document.getElementById("refreshInterval"),channelIdValue=document.getElementById("channelIdValue"),backendStatus=document.getElementById("backendStatus"),backendDot=document.getElementById("backendDot"),backendStatusText=document.getElementById("backendStatusText"),loadoutCount=document.getElementById("loadoutCount"),saveBtn=document.getElementById("saveBtn"),testBtn=document.getElementById("testBtn"),saveSpinner=document.getElementById("saveSpinner"),saveStatus=document.getElementById("saveStatus"),saveMessage=document.getElementById("saveMessage");function initializeTwitchExtension(){window.Twitch&&window.Twitch.ext?(window.Twitch.ext.onAuthorized(t=>{authToken=t.token,channelId=t.channelId,console.log("Config Page Authorized:",{channelId:channelId}),updateConnectionStatus("connected","Connected to Twitch"),channelIdValue.textContent=channelId||"Unknown",loadConfiguration(),testBackendConnection()}),window.Twitch.ext.onContext(t=>{console.log("Twitch Context:",t)})):(console.error("Twitch Extension Helper not available"),updateConnectionStatus("error","Twitch Helper Error"),showError("Twitch Extension Helper not loaded"))}function updateConnectionStatus(t,e){statusText.textContent=e,statusDot.className=`status-dot ${t}`}function updateBackendStatus(t,e){backendStatusText.textContent=e,backendDot.className=`backend-dot ${t}`}function showLoading(){loadingState.style.display="flex",errorState.style.display="none",configForm.style.display="none"}function showError(t){errorMessage.textContent=t,loadingState.style.display="none",errorState.style.display="flex",configForm.style.display="none"}function showConfigForm(){loadingState.style.display="none",errorState.style.display="none",configForm.style.display="grid"}async function testBackendConnection(){try{updateBackendStatus("","Testing...");const t=await fetch(`${API_BASE}/`,{method:"GET",headers:{"Content-Type":"application/json"}});if(t.ok){await t.json();updateBackendStatus("connected","Connected"),channelId&&getLoadoutCount()}else updateBackendStatus("error",`Error ${t.status}`)}catch(t){console.error("Backend connection test failed:",t),updateBackendStatus("error","Connection Failed")}}async function getLoadoutCount(){try{const t={"Content-Type":"application/json"};authToken&&(t.Authorization=`Bearer ${authToken}`);const e=await fetch(`${API_BASE}/api/loadouts/${channelId}`,{method:"GET",headers:t});if(e.ok){const t=await e.json();let n=t;t&&"object"==typeof t&&!Array.isArray(t)&&(n=Object.values(t)),loadoutCount.textContent=n?n.length:0}else loadoutCount.textContent="2 (Test Data)"}catch(t){console.error("Failed to get loadout count:",t),loadoutCount.textContent="2 (Test Data)"}}async function loadConfiguration(){if(channelId)try{showLoading();const t=await fetchConfiguration(channelId,authToken);t&&(currentConfig={...currentConfig,...t}),updateFormFromConfig(),showConfigForm()}catch(t){console.error("Error loading configuration:",t),updateFormFromConfig(),showConfigForm(),showSaveStatus("Config API not available yet. Settings will be stored locally.","error")}else showError("Channel ID not available")}async function fetchConfiguration(t,e){const n={"Content-Type":"application/json"};e&&(n.Authorization=`Bearer ${e}`);const o=await fetch(`${API_BASE}/api/config/${t}`,{method:"GET",headers:n});if(!o.ok){if(404===o.status)return null;throw new Error(`HTTP ${o.status}: ${o.statusText}`)}return await o.json()}async function saveConfiguration(t,e,n){const o={"Content-Type":"application/json"};e&&(o.Authorization=`Bearer ${e}`);const a=await fetch(`${API_BASE}/api/config/${t}`,{method:"POST",headers:o,body:JSON.stringify(n)});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return await a.json()}function updateFormFromConfig(){overlayEnabledInput.checked=currentConfig.overlayEnabled,refreshIntervalSelect.value=currentConfig.refreshInterval.toString()}function updateConfigFromForm(){currentConfig.overlayEnabled=overlayEnabledInput.checked,currentConfig.refreshInterval=parseInt(refreshIntervalSelect.value)}async function handleSaveConfiguration(){if(channelId)try{saveBtn.disabled=!0,saveSpinner.style.display="inline-block",document.querySelector(".btn-text").textContent="Saving...",updateConfigFromForm(),await saveConfiguration(channelId,authToken,currentConfig),showSaveStatus("Configuration saved successfully!","success")}catch(t){console.error("Error saving configuration:",t),localStorage.setItem(`cod-extension-config-${channelId}`,JSON.stringify(currentConfig)),showSaveStatus("Configuration saved locally (API not available)","error")}finally{saveBtn.disabled=!1,saveSpinner.style.display="none",document.querySelector(".btn-text").textContent="Save Configuration"}else showSaveStatus("Channel ID not available","error")}function showSaveStatus(t,e){saveMessage.textContent=t,saveStatus.className=`save-status ${e}`,saveStatus.style.display="block",setTimeout(()=>{saveStatus.style.display="none"},5e3)}async function handleTestConnection(){testBtn.disabled=!0,testBtn.textContent="Testing...";try{await testBackendConnection(),showSaveStatus("Backend connection test completed","success")}catch(t){showSaveStatus("Backend connection test failed","error")}finally{testBtn.disabled=!1,testBtn.textContent="Test Connection"}}function loadLocalConfig(){if(channelId){const t=localStorage.getItem(`cod-extension-config-${channelId}`);if(t)try{const e=JSON.parse(t);currentConfig={...currentConfig,...e}}catch(t){console.error("Error parsing saved config:",t)}}}retryBtn.addEventListener("click",()=>{loadConfiguration()}),saveBtn.addEventListener("click",handleSaveConfiguration),testBtn.addEventListener("click",handleTestConnection),overlayEnabledInput.addEventListener("change",()=>{saveBtn.style.background="linear-gradient(45deg, #ffc107, #ff9800)",setTimeout(()=>{saveBtn.style.background="linear-gradient(45deg, #00e5ff, #0099cc)"},200)}),refreshIntervalSelect.addEventListener("change",()=>{saveBtn.style.background="linear-gradient(45deg, #ffc107, #ff9800)",setTimeout(()=>{saveBtn.style.background="linear-gradient(45deg, #00e5ff, #0099cc)"},200)}),document.addEventListener("DOMContentLoaded",()=>{initializeTwitchExtension()});