const API_BASE="https://cod-extension.netlify.app";let authToken=null,channelId=null,refreshInterval=null;const loadingState=document.getElementById("loadingState"),errorState=document.getElementById("errorState"),loadoutsContainer=document.getElementById("loadoutsContainer"),loadoutTabs=document.getElementById("loadoutTabs"),loadoutContent=document.getElementById("loadoutContent"),statusIndicator=document.getElementById("statusIndicator"),statusDot=statusIndicator.querySelector(".status-dot"),statusText=statusIndicator.querySelector(".status-text"),errorMessage=document.getElementById("errorMessage"),retryBtn=document.getElementById("retryBtn");let currentLoadouts=[],activeLoadoutIndex=0;function initializeTwitchExtension(){window.Twitch&&window.Twitch.ext?(window.Twitch.ext.onAuthorized(e=>{authToken=e.token,channelId=e.channelId,updateStatus("connected","Connected"),loadLoadouts()}),window.Twitch.ext.onContext(e=>{}),window.Twitch.ext.onVisibilityChanged(e=>{e&&channelId&&loadLoadouts()})):(updateStatus("error","Twitch Helper Error"),showError("Twitch Extension Helper not loaded"))}function updateStatus(e,t){statusText.textContent=t,statusDot.className=`status-dot ${e}`}function showLoading(){loadingState.style.display="flex",errorState.style.display="none",loadoutsContainer.style.display="none"}function showError(e){errorMessage.textContent=e,loadingState.style.display="none",errorState.style.display="flex",loadoutsContainer.style.display="none",updateStatus("error","Error")}function showLoadouts(){loadingState.style.display="none",errorState.style.display="none",loadoutsContainer.style.display="block",updateStatus("connected","Connected")}async function fetchLoadouts(e,t){const n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);try{const t=await fetch(`${API_BASE}/api/loadouts/${e}`,{method:"GET",headers:n});if(t.ok){const e=await t.json();return e&&"object"==typeof e&&!Array.isArray(e)?Object.values(e):e}}catch(e){console.log("Primary endpoint failed, trying fallback...")}try{const t=await fetch(`${API_BASE}/api/loadouts/${e}`,{method:"GET",headers:n});if(t.ok){return(await t.json()).loadouts||[]}}catch(e){console.log("Fallback endpoint failed, trying streamers list...")}throw console.log("Primary and fallback endpoints failed"),console.log("All endpoints failed"),new Error(`All API endpoints failed for channel ${e}. Check console for details.`)}async function loadLoadouts(){if(channelId)try{showLoading();const e=await fetchLoadouts(channelId,authToken);if(!e||0===e.length)return void showNoLoadouts();currentLoadouts=e.slice(0,5),renderTabbedLoadouts(currentLoadouts),showLoadouts()}catch(e){console.error("Error loading loadouts:",e),showError(`Failed to load loadouts: ${e.message}`)}else showError("Channel ID not available")}function showNoLoadouts(){loadoutTabs.innerHTML="",loadoutContent.innerHTML='\n    <div class="no-loadouts">\n      <div class="no-loadouts-icon">ðŸŽ®</div>\n      <p>No loadouts available for this streamer</p>\n    </div>\n  ',showLoadouts()}function renderLoadouts(e){loadoutsGrid.innerHTML="",e.forEach((e,t)=>{const n=createLoadoutCard(e,t+1);loadoutsGrid.appendChild(n)})}function createLoadoutCard(e,t){const n=document.createElement("div");n.className="loadout-card";const a=e.name||`Loadout ${t}`,o=e.primary||{},s=e.secondary||{},i=e.tactical||"None",r=e.lethal||"None",d=e.perks||[];return n.innerHTML=`\n        <div class="loadout-header">\n            <div class="loadout-name">${escapeHtml(a)}</div>\n            <div class="loadout-number">#${t}</div>\n        </div>\n        \n        ${renderWeaponSection("Primary",o)}\n        ${renderWeaponSection("Secondary",s)}\n        \n        <div class="equipment-section">\n            <div class="equipment-item">\n                <div class="equipment-label">Tactical</div>\n                <div class="equipment-name">${escapeHtml(i)}</div>\n            </div>\n            <div class="equipment-item">\n                <div class="equipment-label">Lethal</div>\n                <div class="equipment-name">${escapeHtml(r)}</div>\n            </div>\n        </div>\n        \n        <div class="perks-section">\n            <div class="perks-header">Perks</div>\n            <div class="perks-list">\n                ${d.map(e=>`<span class="perk">${escapeHtml(e)}</span>`).join("")}\n            </div>\n        </div>\n    `,n}function renderWeaponSection(e,t){if(!t||!t.name)return`\n            <div class="weapon-section">\n                <div class="weapon-header">${e}</div>\n                <div class="weapon-name">None</div>\n            </div>\n        `;const n=t.attachments||t.attachmentSlots||{},a=Object.entries(n).filter(([e,t])=>t&&"None"!==t).map(([e,t])=>`<span class="attachment">${escapeHtml("string"==typeof t?t:t?.name||"Unknown")}</span>`).join("");return`\n        <div class="weapon-section">\n            <div class="weapon-header">${e}</div>\n            <div class="weapon-info">\n                ${t.imageUrl?`<img src="${escapeHtml(t.imageUrl)}" alt="${escapeHtml(t.name)}" class="weapon-image" onerror="this.style.display='none'">`:""}\n                <div class="weapon-details">\n                    <div class="weapon-name">${escapeHtml(t.name)}</div>\n                    <div class="weapon-category">${escapeHtml(t.category||"Unknown")}</div>\n                </div>\n            </div>\n            ${a?`<div class="attachments">${a}</div>`:""}\n        </div>\n    `}function escapeHtml(e){if("string"!=typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}function renderTabbedLoadouts(e){e&&0!==e.length?(loadoutTabs.innerHTML="",e.forEach((e,t)=>{const n=document.createElement("div");n.className="loadout-tab "+(t===activeLoadoutIndex?"active":""),n.textContent=e.name||`Loadout ${t+1}`,n.addEventListener("click",()=>switchToLoadout(t)),loadoutTabs.appendChild(n)}),renderActiveLoadout()):showNoLoadouts()}function switchToLoadout(e){if(e<0||e>=currentLoadouts.length)return;activeLoadoutIndex=e;loadoutTabs.querySelectorAll(".loadout-tab").forEach((t,n)=>{t.classList.toggle("active",n===e)}),renderActiveLoadout()}async function renderActiveLoadout(){if(!currentLoadouts[activeLoadoutIndex])return;const e=currentLoadouts[activeLoadoutIndex];loadoutContent.innerHTML=`\n    <div class="loadout-header">\n      <div class="loadout-name">${escapeHtml(e.name||`Loadout ${activeLoadoutIndex+1}`)}</div>\n    </div>\n    \n    ${await renderWeaponSectionWithImage("Primary",e.primary)}\n    ${await renderWeaponSectionWithImage("Secondary",e.secondary)}\n    \n    <div class="equipment-section">\n      ${renderEquipmentItem("Tactical",e.tactical)}\n      ${renderEquipmentItem("Lethal",e.lethal)}\n      ${renderEquipmentItem("Field Upgrade",e.fieldUpgrade)}\n    </div>\n    \n    <div class="perks-section">\n      <div class="perks-header">Perks</div>\n      <div class="perks-list">\n        ${renderPerksWithImages(e.perks)}\n      </div>\n    </div>\n  `}async function renderWeaponSectionWithImage(e,t){if(!t||!t.name)return`\n      <div class="weapon-section">\n        <div class="weapon-header">${e}</div>\n        <div class="weapon-name">None</div>\n      </div>\n    `;let n=t.imageUrl||t.image;n&&!n.startsWith("http")&&(n=null);const a=t.attachments||t.attachmentSlots||{},o=Object.entries(a).filter(([e,t])=>t&&"None"!==t).map(([e,t])=>{const n="string"==typeof t?t:t?.name||"Unknown";return`\n        <div class="attachment-item">\n          <span class="attachment-slot">${escapeHtml(e)}:</span>\n          <span class="attachment">${escapeHtml(n)}</span>\n        </div>\n      `}).join("");return`\n    <div class="weapon-section">\n      <div class="weapon-header">${e}</div>\n      <div class="weapon-name-large">${escapeHtml(t.name)}</div>\n      <div class="weapon-category">${escapeHtml(t.category||"Unknown")}</div>\n      ${n?`<div class="weapon-image-container">\n              <img src="${escapeHtml(n)}" alt="${escapeHtml(t.name)}" class="weapon-image-large" onerror="this.parentElement.style.display='none'">\n            </div>`:""}\n      ${o?`<div class="attachments-list">${o}</div>`:""}\n    </div>\n  `}function getEquipmentName(e){return e?"string"==typeof e?e:"object"==typeof e&&e.name?e.name:"None":"None"}function formatPerks(e){return e&&Array.isArray(e)?e.map(e=>{let t="Unknown Perk";return"string"==typeof e?t=e:"object"==typeof e&&e.name&&(t=e.name),`<span class="perk">${escapeHtml(t)}</span>`}).join(""):""}function renderEquipmentItem(e,t){const n=getEquipmentName(t);let a=null;return t&&"object"==typeof t&&t.imageUrl&&(a=t.imageUrl,a&&!a.startsWith("http")&&(a=null)),`\n    <div class="equipment-item">\n      <div class="equipment-label">${escapeHtml(e)}</div>\n      ${a?`<img src="${escapeHtml(a)}" alt="${escapeHtml(n)}" class="equipment-image" onerror="this.style.display='none'">`:""}\n      <div class="equipment-name">${escapeHtml(n)}</div>\n    </div>\n  `}function renderPerksWithImages(e){return e&&Array.isArray(e)?e.map(e=>{let t="Unknown Perk",n=null;return"string"==typeof e?t=e:"object"==typeof e&&e&&(t=e.name||"Unknown Perk",n=e.imageUrl,n&&!n.startsWith("http")&&(n=null)),`\n        <div class="perk-item">\n          ${n?`<img src="${escapeHtml(n)}" alt="${escapeHtml(t)}" class="perk-image" onerror="this.style.display='none'">`:""}\n          <span class="perk">${escapeHtml(t)}</span>\n        </div>\n      `}).join(""):""}retryBtn.addEventListener("click",()=>{loadLoadouts()}),document.addEventListener("DOMContentLoaded",()=>{initializeTwitchExtension()}),window.addEventListener("beforeunload",()=>{refreshInterval&&clearInterval(refreshInterval)});